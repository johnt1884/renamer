<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video File Renamer - Fixed Thumbnails</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #ffffff;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Left Panel */
        .left-panel {
            width: 300px;
            background: #2d2d2d;
            border-right: 1px solid #444;
            overflow-y: auto;
            padding: 10px;
        }

        .load-btn {
            width: 100%;
            padding: 12px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .load-btn:hover { background: #106ebe; }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #444;
            border-radius: 2px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #0078d4;
            width: 0%;
            transition: width 0.3s;
        }

        .saved-names { font-size: 12px; }
        .saved-name-item {
            padding: 8px;
            margin: 4px 0;
            background: #3d3d3d;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .saved-name-item:hover { background: #4d4d4d; }
        .saved-name-item.active { background: #0078d4; }

        /* Main Area */
        .main-area {
            flex: 1;
            padding: 20px;
            overflow: auto;
            background: #1e1e1e;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group { display: flex; gap: 5px; align-items: center; }
        select, button {
            padding: 6px 10px;
            border: 1px solid #444;
            background: #2d2d2d;
            color: white;
            border-radius: 4px;
        }

        .pagination {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            min-height: 400px;
        }

        .file-item {
            position: relative;
            border: 2px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            background: #2d2d2d;
        }

        .file-item:hover { border-color: #666; }
        .file-item.selected { 
            border-color: #0078d4; 
            background: #3d3d3d; 
        }

        /* **EXACT WINDOWS THUMBNAIL SIZE** */
        .video-container {
            position: relative;
            width: 100%;
            height: 100px;  /* FIXED HEIGHT */
            overflow: hidden;
        }

        .video-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;  /* PERFECT ASPECT RATIO */
            display: block;
        }

        /* **PLAY BUTTON - ONLY WHEN SELECTED** */
        .play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0, 120, 212, 0.9);
            color: white;
            border: none;
            display: none;  /* HIDDEN BY DEFAULT */
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 3;
            font-size: 14px;
        }

        .file-item.selected .play-button {
            display: flex;  /* SHOW ONLY WHEN SELECTED */
        }

        .play-button:hover {
            background: #0078d4;
            transform: translate(-50%, -50%) scale(1.1);
        }

        .checkbox {
            position: absolute;
            top: 5px;
            left: 5px;
            z-index: 4;
            cursor: pointer;
        }

        .file-info {
            padding: 8px;
            min-height: 60px;
        }

        .file-original {
            font-size: 10px;
            color: #888;
            margin-bottom: 2px;
            word-break: break-all;
            line-height: 1.2;
        }

        .file-new {
            font-weight: bold;
            font-size: 11px;
            word-break: break-all;
            line-height: 1.2;
        }

        /* Bottom Panel */
        .bottom-panel {
            height: 200px;
            background: #2d2d2d;
            border-top: 1px solid #444;
            padding: 15px;
            overflow-y: auto;
        }

        .name-builder { display: flex; flex-direction: column; gap: 10px; }
        .input-group { display: flex; gap: 5px; align-items: center; }
        .input-group input {
            flex: 1;
            padding: 6px;
            border: 1px solid #444;
            background: #1e1e1e;
            color: white;
            border-radius: 4px;
        }

        .add-subcat-btn, .save-name-btn { 
            padding: 8px 15px; 
            background: #107c10; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }

        .generate-bat-btn {
            background: #d13438;
            width: 100%;
            padding: 12px;
            font-size: 16px;
            margin-top: 10px;
        }

        .subcat-list { max-height: 80px; overflow-y: auto; }
        .subcat-item { display: flex; gap: 5px; align-items: center; padding: 3px 0; }
        .remove-subcat {
            background: #d13438;
            border: none;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
        }

        /* INLINE VIDEO PLAYER */
        .inline-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 2;
        }

        .file-item.selected.playing .inline-player {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel -->
        <div class="left-panel">
            <button class="load-btn" onclick="loadDirectory()">Load Directory</button>
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText" style="font-size: 12px; margin-bottom: 10px;"></div>
            <div class="saved-names">
                <h4 style="margin-bottom: 10px; color: #ccc;">Saved Names</h4>
                <div id="savedNamesList"></div>
            </div>
        </div>

        <!-- Main Area -->
        <div class="main-area">
            <div class="controls">
                <div class="control-group">
                    <label>Sort:</label>
                    <select id="sortMode" onchange="sortFiles()">
                        <option value="original">Original Name</option>
                        <option value="new">New Name</option>
                        <option value="random">Random</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Page: <span id="currentPage">1</span> of <span id="totalPages">1</span></label>
                    <button onclick="prevPage()">←</button>
                    <button onclick="nextPage()">→</button>
                </div>
                <div class="control-group">
                    <label>Selected: <span id="selectedCount">0</span></label>
                    <button onclick="selectAll()">Select All</button>
                    <button onclick="deselectAll()">Deselect All</button>
                </div>
            </div>

            <div id="loadingMsg" class="loading" style="display: none;">
                Loading videos...
            </div>
            <div id="fileGrid" class="file-grid"></div>

            <div class="pagination" id="pagination" style="display: none;">
                <button onclick="prevPage()">Previous</button>
                <button onclick="nextPage()">Next</button>
            </div>
        </div>
    </div>

    <!-- Bottom Panel -->
    <div class="bottom-panel">
        <div class="name-builder">
            <div class="input-group">
                <label>Username:</label>
                <input type="text" id="username" placeholder="e.g., tntsports">
            </div>
            <div class="input-group">
                <label>Category:</label>
                <input type="text" id="category" placeholder="e.g., Matches">
            </div>
            <div class="subcat-list" id="subcatList"></div>
            <button class="add-subcat-btn" onclick="addSubCategory()">+ Add Sub Category</button>
            <button class="save-name-btn" onclick="saveCurrentName()">Save Current Name</button>
            <button class="generate-bat-btn" onclick="generateBatFile()">Generate Rename BAT</button>
        </div>
    </div>

    <script>
        let files = [];
        let savedNames = JSON.parse(localStorage.getItem('savedNames')) || [];
        let lastLoadedDir = localStorage.getItem('lastLoadedDir') || '';
        let lastLookedDir = localStorage.getItem('lastLookedDir') || '';
        let fileMap = new Map();
        let selectedFiles = new Set();
        let currentPage = 1;
        const FILES_PER_PAGE = 50;
        let totalLoaded = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedNames();
        });

        // **RECALL LAST DIRECTORIES**
        async function loadDirectory() {
            if ('showDirectoryPicker' in window) {
                try {
                    // Use last looked directory handle if available
                    let dirHandle;
                    if (lastLookedDir && window.__directories && window.__directories[lastLookedDir]) {
                        dirHandle = window.__directories[lastLookedDir];
                    } else {
                        dirHandle = await window.showDirectoryPicker();
                    }
                    
                    // Save as last looked
                    lastLookedDir = dirHandle.name;
                    localStorage.setItem('lastLookedDir', lastLookedDir);
                    
                    currentDir = dirHandle.name;
                    lastLoadedDir = currentDir;
                    localStorage.setItem('lastLoadedDir', lastLoadedDir);
                    
                    // Store handle for future use
                    if (!window.__directories) window.__directories = {};
                    window.__directories[lastLookedDir] = dirHandle;
                    
                    files = [];
                    fileMap.clear();
                    selectedFiles.clear();
                    currentPage = 1;
                    
                    showProgress();
                    await readDirectoryAsync(dirHandle);
                } catch (err) {
                    console.error('Error:', err);
                    alert('Please select directory manually');
                    window.showDirectoryPicker().then(handle => loadDirectoryWithHandle(handle));
                }
            }
        }

        async function loadDirectoryWithHandle(dirHandle) {
            currentDir = dirHandle.name;
            lastLoadedDir = currentDir;
            localStorage.setItem('lastLoadedDir', lastLoadedDir);
            await readDirectoryAsync(dirHandle);
        }

        async function readDirectoryAsync(dirHandle) {
            totalLoaded = 0;
            const allFiles = [];
            
            for await (const entry of dirHandle.values()) {
                if (entry.kind === 'file' && entry.name.match(/\.(mp4|avi|mkv|mov|wmv)$/i)) {
                    const file = await entry.getFile();
                    const originalName = entry.name;
                    const newName = parseExistingName(originalName) || originalName;
                    
                    allFiles.push({
                        handle: entry,
                        originalName,
                        newName,
                        file,
                        id: Date.now() + Math.random(),
                        thumbnailUrl: null
                    });
                    
                    totalLoaded++;
                    updateProgress(totalLoaded, allFiles.length);
                }
            }
            
            files = allFiles;
            await generateThumbnails();
            
            const matchingFiles = files.filter(f => isMatchingScheme(f.originalName));
            if (matchingFiles.length > 0) {
                if (confirm(`Found ${matchingFiles.length} files with naming scheme. Add to saved names?`)) {
                    savedNames.push(...files.filter(f => isMatchingScheme(f.originalName))
                        .map(f => f.originalName.replace(/\s*\(\d+\)\..*$/, '')));
                    localStorage.setItem('savedNames', JSON.stringify(savedNames));
                    loadSavedNames();
                }
            }
            
            suggestUsername();
            hideProgress();
            renderFiles();
            sortFiles();
            updatePagination();
        }

        // **PERFECT THUMBNAIL GENERATION**
        async function generateThumbnails() {
            const thumbnailPromises = files.map(async (file) => {
                return new Promise((resolve) => {
                    const video = document.createElement('video');
                    const canvas = document.createElement('canvas');
                    canvas.width = 150;  // EXACT WINDOWS WIDTH
                    canvas.height = 100; // EXACT WINDOWS HEIGHT
                    const ctx = canvas.getContext('2d');
                    
                    // Gray fallback
                    ctx.fillStyle = '#333';
                    ctx.fillRect(0, 0, 150, 100);
                    
                    video.src = URL.createObjectURL(file.file);
                    video.muted = true;
                    
                    video.onloadedmetadata = () => {
                        video.currentTime = Math.min(1, video.duration * 0.05); // 5% into video
                    };
                    
                    video.onseeked = () => {
                        ctx.drawImage(video, 0, 0, 150, 100);
                        file.thumbnailUrl = canvas.toDataURL();
                        URL.revokeObjectURL(video.src);
                        resolve();
                    };
                    
                    video.onerror = () => {
                        file.thumbnailUrl = canvas.toDataURL();
                        resolve();
                    };
                });
            });
            
            await Promise.all(thumbnailPromises);
        }

        // **RENDER WITH PROPER SIZING**
        function renderFiles() {
            const start = (currentPage - 1) * FILES_PER_PAGE;
            const end = start + FILES_PER_PAGE;
            const pageFiles = files.slice(start, end);
            
            document.getElementById('fileGrid').innerHTML = pageFiles.map(file => `
                <div class="file-item" data-id="${file.id}" onclick="toggleSelect('${file.id}')">
                    <!-- Checkbox -->
                    <input type="checkbox" class="checkbox" 
                           onchange="toggleSelect('${file.id}')" 
                           ${selectedFiles.has(file.id) ? 'checked' : ''}>
                    
                    <!-- Thumbnail -->
                    <div class="video-container">
                        <img src="${file.thumbnailUrl}" 
                             class="video-preview" 
                             alt="Thumbnail">
                        
                        <!-- INLINE VIDEO PLAYER -->
                        <video class="inline-player" 
                               id="video-${file.id}"
                               src="${URL.createObjectURL(file.file)}"
                               muted
                               loop
                               style="width:100%; height:100%; object-fit:cover;">
                        </video>
                        
                        <!-- **PLAY BUTTON - ONLY WHEN SELECTED** -->
                        <button class="play-button" 
                                onclick="togglePlay('${file.id}', event)">
                            ▶
                        </button>
                    </div>
                    
                    <!-- File Info -->
                    <div class="file-info">
                        <div class="file-original">${file.originalName}</div>
                        <div class="file-new">${file.newName}</div>
                    </div>
                </div>
            `).join('');
        }

        // **CLICK ANYWHERE = SELECT ONLY**
        function toggleSelect(id) {
            const item = document.querySelector(`[data-id="${id}"]`);
            const checkbox = item.querySelector('.checkbox');
            
            if (selectedFiles.has(id)) {
                selectedFiles.delete(id);
                item.classList.remove('selected', 'playing');
                checkbox.checked = false;
                // Stop video if playing
                const video = document.getElementById(`video-${id}`);
                if (video) video.pause();
            } else {
                selectedFiles.add(id);
                item.classList.add('selected');
                checkbox.checked = true;
            }
            updateSelectedCount();
        }

        // **PLAY BUTTON FUNCTION**
        function togglePlay(fileId, event) {
            event.stopPropagation();
            
            const item = document.querySelector(`[data-id="${fileId}"]`);
            const video = document.getElementById(`video-${fileId}`);
            const playBtn = item.querySelector('.play-button');
            
            if (video.paused) {
                video.play();
                item.classList.add('playing');
                playBtn.textContent = '⏸';
            } else {
                video.pause();
                item.classList.remove('playing');
                playBtn.textContent = '▶';
            }
        }

        // Progress functions
        function showProgress() {
            document.getElementById('progressBar').style.display = 'block';
            document.getElementById('progressText').style.display = 'block';
            document.getElementById('loadingMsg').style.display = 'block';
            document.getElementById('fileGrid').innerHTML = '';
        }

        function hideProgress() {
            document.getElementById('progressBar').style.display = 'none';
            document.getElementById('progressText').style.display = 'none';
            document.getElementById('loadingMsg').style.display = 'none';
        }

        function updateProgress(current, total) {
            const progress = (current / total * 100);
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `Loaded ${current}/${total} files`;
        }

        // Pagination
        function updatePagination() {
            const totalPages = Math.ceil(files.length / FILES_PER_PAGE);
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('pagination').style.display = totalPages > 1 ? 'flex' : 'none';
        }

        function prevPage() {
            if (currentPage > 1) {
                pauseAllVideos();
                currentPage--;
                renderFiles();
                updatePagination();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(files.length / FILES_PER_PAGE);
            if (currentPage < totalPages) {
                pauseAllVideos();
                currentPage++;
                renderFiles();
                updatePagination();
            }
        }

        function pauseAllVideos() {
            files.forEach(file => {
                const video = document.getElementById(`video-${file.id}`);
                if (video) {
                    video.pause();
                    const item = document.querySelector(`[data-id="${file.id}"]`);
                    if (item) {
                        item.classList.remove('playing');
                        item.querySelector('.play-button').textContent = '▶';
                    }
                }
            });
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedFiles.size;
        }

        function selectAll() {
            const start = (currentPage - 1) * FILES_PER_PAGE;
            const end = start + FILES_PER_PAGE;
            const pageFiles = files.slice(start, end);
            pageFiles.forEach(file => selectedFiles.add(file.id));
            renderFiles();
            updateSelectedCount();
        }

        function deselectAll() {
            pauseAllVideos();
            selectedFiles.clear();
            renderFiles();
            updateSelectedCount();
        }

        // Name builder functions (unchanged)
        function sortFiles() {
            pauseAllVideos();
            const sortMode = document.getElementById('sortMode').value;
            if (sortMode === 'original') {
                files.sort((a, b) => a.originalName.localeCompare(b.originalName));
            } else if (sortMode === 'new') {
                files.sort((a, b) => a.newName.localeCompare(b.newName));
            } else if (sortMode === 'random') {
                files.sort(() => Math.random() - 0.5);
            }
            currentPage = 1;
            renderFiles();
            updatePagination();
        }

        function addSubCategory() {
            const subcatList = document.getElementById('subcatList');
            const div = document.createElement('div');
            div.className = 'subcat-item';
            div.innerHTML = `
                <input type="text" placeholder="Sub Category">
                <button class="remove-subcat" onclick="removeSubCategory(this)">×</button>
            `;
            subcatList.appendChild(div);
        }

        function removeSubCategory(btn) { btn.parentElement.remove(); }

        function buildNewName() {
            const username = document.getElementById('username').value;
            const category = document.getElementById('category').value;
            const subcats = Array.from(document.querySelectorAll('#subcatList input')).map(input => input.value).filter(v => v);
            let name = `[${username}]_${category}`;
            subcats.forEach(subcat => name += ` (${subcat})`);
            return name;
        }

        function applyNameToSelected() {
            const baseName = buildNewName();
            const selectedFileIds = Array.from(selectedFiles);
            const existingCount = files.filter(f => f.newName.startsWith(baseName)).length;
            
            selectedFileIds.forEach((id, index) => {
                const file = files.find(f => f.id === id);
                if (file) {
                    const number = existingCount + index + 1;
                    file.newName = `${baseName} (${number})`;
                    fileMap.set(file.originalName, file.newName);
                }
            });
            renderFiles();
        }

        function saveCurrentName() {
            const newName = buildNewName();
            if (newName && !savedNames.includes(newName)) {
                savedNames.push(newName);
                localStorage.setItem('savedNames', JSON.stringify(savedNames));
                loadSavedNames();
            }
        }

        function loadSavedNames() {
            const list = document.getElementById('savedNamesList');
            list.innerHTML = savedNames.map(name => 
                `<div class="saved-name-item" onclick="applySavedName('${name}')">${name}</div>`
            ).join('');
        }

        function applySavedName(savedName) {
            document.querySelectorAll('.saved-name-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            
            const match = savedName.match(/^\[(.*?)\]_(.*?)(\s*\(.*?\))*$/);
            if (match) {
                document.getElementById('username').value = match[1];
                document.getElementById('category').value = match[2];
                document.getElementById('subcatList').innerHTML = '';
                
                const subcatMatches = savedName.match(/\(([^)]+)\)/g) || [];
                subcatMatches.slice(1).forEach(subcat => {
                    addSubCategory();
                    document.querySelector('#subcatList input:last-child').value = subcat.slice(1, -1);
                });
            }
            applyNameToSelected();
        }

        function suggestUsername() {
            if (files.length > 0) {
                const firstWord = files[0].originalName.split('_')[0]?.replace(/\[|\]/g, '');
                document.getElementById('username').value = firstWord || '';
            }
            document.querySelector('.bottom-panel').style.display = 'block';
        }

        function isMatchingScheme(filename) {
            return filename.match(/^\[.*?\]_(.*?)(\s*\(.*?\))*\s*\(\d+\)\.(mp4|avi|mkv|mov|wmv)$/i);
        }

        function parseExistingName(filename) {
            return isMatchingScheme(filename) ? filename : null;
        }

        async function generateBatFile() {
            if (files.length === 0) return alert('No files loaded!');
            
            let batContent = '@echo off\necho Renaming files...\n\n';
            for (const file of files) {
                if (file.originalName !== file.newName) {
                    batContent += `ren "${file.originalName}" "${file.newName}"\n`;
                }
            }
            batContent += '\necho Done!\npause';

            const blob = new Blob([batContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rename_${currentDir.replace(/[^a-zA-Z0-9]/g, '_')}.bat`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Auto-apply
        document.getElementById('username').addEventListener('input', applyNameToSelected);
        document.getElementById('category').addEventListener('input', applyNameToSelected);
        document.getElementById('subcatList').addEventListener('input', applyNameToSelected);

        // Cleanup
        window.addEventListener('beforeunload', () => {
            files.forEach(file => {
                if (file.file) URL.revokeObjectURL(URL.createObjectURL(file.file));
            });
        });
    </script>
</body>
</html>
