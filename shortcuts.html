<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shortcuts</title>
     <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #EBEBEB;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .top-bar {
            padding: 10px;
            border-bottom: 1px solid #444444;
            display: flex;
            align-items: center;
            height: 36px;
            box-sizing: border-box;
            background-color: #1877f2;
        }
        .bottom-bar {
            padding: 10px;
            border-top: 1px solid #444444;
            display: flex;
            align-items: center;
            height: 36px;
            box-sizing: border-box;
            background-color: #1877f2;
            color: white;
            justify-content: space-between;
        }
        #thumbnail-container {
            flex-grow: 1;
            padding: 20px;
            position: relative;
            overflow: auto;
            min-width: 0;
        }
        .thumbnail {
            object-fit: cover;
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 2500;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 24px;
            border: none;
            border-radius: 8px;
            width: 90%;
            max-width: 680px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .close {
            color: #606770;
            float: right;
            font-size: 32px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #1c1e21;
            text-decoration: none;
            cursor: pointer;
        }
        #batch-script {
            width: 100%;
            box-sizing: border-box;
            border-radius: 6px;
            border: 1px solid #ccd0d5;
            padding: 8px;
            font-family: "Courier New", Courier, monospace;
            margin-top: 8px;
            margin-bottom: 12px;
            resize: vertical;
        }
        .landscape-row {
            margin-bottom: 10px;
        }
        .landscape-row.selected-shortcut {
            outline: 3px dashed orange;
        }
        select {
            height: 36px;
            padding: 0 8px 0 8px;
            padding-right: 32px;
            border: 1px solid #444444;
            background-color: #1877f2;
            color: #ffffff;
            border-radius: 0;
            font-size: 14px;
            box-sizing: border-box;
            margin-right: 10px;
            text-align: center;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
        }
        select option {
            padding: 8px 12px;
            background-color: #ffffff;
            color: #000000;
        }
        .bar-button {
            height: 36px;
            padding: 0 12px;
            border: 1px solid #444444;
            background-color: #1877f2;
            color: #ffffff;
            border-radius: 0;
            font-size: 14px;
            cursor: pointer;
        }
        .bar-button:hover {
            background-color: #166fe5;
        }
        .project-header {
            color: #1c1e21;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="main-content">
            <div class="top-bar">
                <button id="load-directory-btn" class="bar-button">Load Directory</button>
                <select id="size-selector">
                    <option value="0.2">20%</option>
                    <option value="0.3">30%</option>
                    <option value="0.4">40%</option>
                    <option value="0.5">50%</option>
                    <option value="0.6">60%</option>
                    <option value="0.7">70%</option>
                    <option value="0.8">80%</option>
                    <option value="0.9">90%</option>
                    <option value="1" selected>100%</option>
                </select>
                <select id="sort-selector">
                    <option value="" disabled selected hidden>Sort</option>
                    <option value="name-asc">Name (A-Z)</option>
                    <option value="name-desc">Name (Z-A)</option>
                    <option value="date-new">Date (Newest)</option>
                    <option value="date-old">Date (Oldest)</option>
                </select>
            </div>
            <div id="content-area" style="display: flex; flex-grow: 1; overflow: hidden;">
                <div id="thumbnail-container">
                    <div id="content-spacer" style="position: absolute; top: 0; left: 0; z-index: -1;"></div>
                </div>
            </div>
            <div class="bottom-bar">
                <button id="shortcut-script-btn" class="bar-button">Create Shortcut Script</button>
            </div>
        </div>
    </div>

    <div id="script-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Create Shortcut PowerShell Script</h2>
            <p>This script will create shortcuts for your selections. Right-click and "Run with PowerShell" in your main video directory.</p>
            <textarea id="batch-script" rows="10" cols="80" readonly></textarea>
            <button id="copy-script-btn">Copy to Clipboard</button>
            <a id="download-script-link" download="create_shortcuts.ps1">
                <button>Download .ps1 File</button>
            </a>
        </div>
    </div>

    <script>
        const thumbnailContainer = document.getElementById('thumbnail-container');
        const scriptModal = document.getElementById('script-modal');
        const batchScriptTextArea = document.getElementById('batch-script');
        const copyScriptBtn = document.getElementById('copy-script-btn');
        const downloadScriptLink = document.getElementById('download-script-link');
        const sizeSelector = document.getElementById('size-selector');
        const sortSelector = document.getElementById('sort-selector');
        const loadButton = document.getElementById('load-directory-btn');
        const shortcutScriptBtn = document.getElementById('shortcut-script-btn');
        const contentSpacer = document.getElementById('content-spacer');

        let allVideoFiles = [];
        let shortcutSelections = new Set();
        let currentDirHandle;

        function updateContentSpacer() {
            const elements = document.querySelectorAll('.landscape-row, .project-header, hr');
            if (elements.length === 0) {
                contentSpacer.style.height = '0px';
                return;
            }
            let maxBottom = 0;
            elements.forEach(el => {
                const bottom = el.offsetTop + el.offsetHeight;
                if (bottom > maxBottom) maxBottom = bottom;
            });
            contentSpacer.style.height = (maxBottom + 20) + 'px';
        }

        function layoutLandscapeThumbnails() {
            const scale = parseFloat(sizeSelector.value);
            const elements = document.querySelectorAll('.landscape-row, .project-header, hr');

            elements.forEach(element => {
                if (element.classList.contains('landscape-row')) {
                    let maxRowHeight = 0;
                    const thumbnails = element.querySelectorAll('.thumbnail');
                    thumbnails.forEach(thumb => {
                        const originalWidth = parseFloat(thumb.dataset.originalWidth);
                        const originalHeight = parseFloat(thumb.dataset.originalHeight);
                        const scaledWidth = originalWidth * scale;
                        const scaledHeight = originalHeight * scale;
                        thumb.style.width = scaledWidth + 'px';
                        thumb.style.height = scaledHeight + 'px';
                        thumb.style.marginRight = '10px';
                        if (scaledHeight > maxRowHeight) maxRowHeight = scaledHeight;
                    });
                    element.style.height = maxRowHeight + 'px';
                }
            });
            requestAnimationFrame(updateContentSpacer);
        }

        function generateShortcutScript() {
            const groupedByProject = new Map();
            shortcutSelections.forEach(sel => {
                if (!groupedByProject.has(sel.projectPath)) {
                    groupedByProject.set(sel.projectPath, []);
                }
                groupedByProject.get(sel.projectPath).push(sel.videoName);
            });

            let scriptLines = [
                '$PSScriptRoot = Split-Path -Parent -Path $MyInvocation.MyCommand.Definition',
                '$wshell = New-Object -ComObject WScript.Shell',
                ''
            ];

            groupedByProject.forEach((videoNames, projectPath) => {
                const projectPathPS = projectPath ? `Join-Path -Path $PSScriptRoot -ChildPath '${projectPath}'` : '$PSScriptRoot';
                const scDirPS = `Join-Path -Path (${projectPathPS}) -ChildPath 'sc'`;

                scriptLines.push(`Write-Host "Processing project: ${projectPath || '(Root)'}"`);
                scriptLines.push(`if (-not (Test-Path -LiteralPath ${scDirPS})) { New-Item -ItemType Directory -Path ${scDirPS} }`);

                videoNames.forEach(videoName => {
                    const videoFile = allVideoFiles.find(f => f.name.startsWith(videoName));
                    if (videoFile) {
                        const targetPathPS = `Join-Path -Path (${projectPathPS}) -ChildPath '${videoFile.name}'`;
                        const shortcutPathPS = `Join-Path -Path (${scDirPS}) -ChildPath '${videoFile.name}.lnk'`;
                        scriptLines.push(`$shortcut = $wshell.CreateShortcut(${shortcutPathPS})`);
                        scriptLines.push(`$shortcut.TargetPath = ${targetPathPS}`);
                        scriptLines.push(`$shortcut.Save()`);
                    }
                });
                scriptLines.push('');
            });

            scriptLines.push('Write-Host "Shortcut creation complete."');
            scriptLines.push('Read-Host -Prompt "Press Enter to exit"');

            const script = scriptLines.join('\r\n');
            batchScriptTextArea.value = script;
            const blob = new Blob([script], { type: 'text/plain;charset=utf-8' });
            downloadScriptLink.href = URL.createObjectURL(blob);
        }

        async function renderShortcutMode(sortBy = 'name-asc') {
            thumbnailContainer.innerHTML = '';
            shortcutSelections.clear();

            const projectFolders = [];

            async function findProjectFolders(dirHandle, currentPath = '') {
                 for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'directory') {
                        const newPath = currentPath ? `${currentPath}\\${entry.name}` : entry.name;
                        try {
                            await entry.getDirectoryHandle('Edit Thumbnails');
                            projectFolders.push({ handle: entry, path: newPath, name: entry.name });
                        } catch (e) {
                           await findProjectFolders(entry, newPath);
                        }
                    }
                }
            }

            try {
                await currentDirHandle.getDirectoryHandle('Edit Thumbnails');
                projectFolders.push({ handle: currentDirHandle, path: '', name: currentDirHandle.name });
            } catch (e) {
                await findProjectFolders(currentDirHandle);
            }


            if (projectFolders.length === 0) {
                alert('No "Edit Thumbnails" folders found in the selected directory or its subdirectories.');
                return;
            }

            for (const project of projectFolders) {
                const header = document.createElement('h2');
                header.className = 'project-header';
                header.textContent = project.name;
                thumbnailContainer.appendChild(header);

                let mostRecentShortcutTime = 0;
                try {
                    const scDirHandle = await project.handle.getDirectoryHandle('sc');
                    for await (const entry of scDirHandle.values()) {
                        if (entry.kind === 'file' && entry.name.endsWith('.lnk')) {
                            const file = await entry.getFile();
                            if (file.lastModified > mostRecentShortcutTime) {
                                mostRecentShortcutTime = file.lastModified;
                            }
                        }
                    }
                } catch(e) { /* no sc folder */ }

                const editDirHandle = await project.handle.getDirectoryHandle('Edit Thumbnails');
                const landscapeFiles = [];
                for await (const entry of editDirHandle.values()) {
                    if (entry.kind === 'file' && entry.name.match(/\.(jpe?g|png|gif|webp)$/i)) {
                        const file = await entry.getFile();
                        if (file.lastModified > mostRecentShortcutTime) {
                            landscapeFiles.push(file);
                        }
                    }
                }
                allVideoFiles = []; // Clear for each project
                for await (const entry of project.handle.values()) {
                    if (entry.kind === 'file' && entry.name.match(/\.(mp4|avi|mov|mkv)$/i)) {
                        allVideoFiles.push(await entry.getFile());
                    }
                }

                const groupedFiles = landscapeFiles.reduce((acc, file) => {
                    const videoName = file.name.substring(0, file.name.lastIndexOf('_'));
                    if (!acc[videoName]) acc[videoName] = [];
                    acc[videoName].push(file);
                    return acc;
                }, {});

                let videoNames = Object.keys(groupedFiles);
                const videoFileMap = new Map(allVideoFiles.map(f => [f.name.substring(0, f.name.lastIndexOf('.')), f]));

                videoNames.sort((a, b) => {
                    if (sortBy === 'name-asc') return a.localeCompare(b);
                    if (sortBy === 'name-desc') return b.localeCompare(a);
                    const fileA = videoFileMap.get(a);
                    const fileB = videoFileMap.get(b);
                    const dateA = fileA ? fileA.lastModified : 0;
                    const dateB = fileB ? fileB.lastModified : 0;
                    if (sortBy === 'date-new') return dateB - dateA;
                    if (sortBy === 'date-old') return dateA - dateB;
                    return 0;
                });

                for (const videoName of videoNames) {
                    const files = groupedFiles[videoName].sort((a, b) => {
                        const aNum = parseInt(a.name.substring(a.name.lastIndexOf('_') + 1));
                        const bNum = parseInt(b.name.substring(b.name.lastIndexOf('_') + 1));
                        return aNum - bNum;
                    });

                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'landscape-row';
                    rowDiv.dataset.videoName = videoName;
                    rowDiv.dataset.projectPath = project.path;
                    thumbnailContainer.appendChild(rowDiv);

                    rowDiv.addEventListener('click', () => {
                        rowDiv.classList.toggle('selected-shortcut');
                        const selectionData = { videoName: videoName, projectPath: project.path };

                        let found = false;
                        shortcutSelections.forEach(s => {
                            if (s.videoName === selectionData.videoName && s.projectPath === selectionData.projectPath) {
                                found = true;
                                shortcutSelections.delete(s);
                            }
                        });

                        if (!found) {
                            shortcutSelections.add(selectionData);
                        }
                    });

                    const imageLoadPromises = files.map(file => {
                        return new Promise((resolve, reject) => {
                            const img = new Image();
                            img.onload = () => {
                                img.className = 'thumbnail';
                                img.dataset.fileName = file.name;
                                img.dataset.originalWidth = img.width;
                                img.dataset.originalHeight = img.height;
                                rowDiv.appendChild(img);
                                resolve();
                            };
                            img.onerror = reject;
                            img.src = URL.createObjectURL(file);
                        });
                    });
                    await Promise.all(imageLoadPromises);
                }
                 const hr = document.createElement('hr');
                thumbnailContainer.appendChild(hr);
            }
            layoutLandscapeThumbnails();
        }

        window.onload = () => {
            loadButton.addEventListener('click', async () => {
                try {
                    const dirHandle = await window.showDirectoryPicker();
                    currentDirHandle = dirHandle;
                    await renderShortcutMode();
                } catch (err) {
                    if (err.name !== 'AbortError') console.error('Failed to open directory:', err);
                }
            });

            scriptModal.querySelector('.close').addEventListener('click', () => scriptModal.style.display = 'none');

            copyScriptBtn.addEventListener('click', () => {
                 batchScriptTextArea.select();
                 navigator.clipboard.writeText(batchScriptTextArea.value).then(() => {
                    alert('Script copied to clipboard!');
                });
            });

            shortcutScriptBtn.addEventListener('click', () => {
                if (shortcutSelections.size === 0) {
                    alert('Please select one or more thumbnails to create shortcuts for.');
                    return;
                }
                generateShortcutScript();
                scriptModal.style.display = 'block';
            });

            sizeSelector.addEventListener('change', () => layoutLandscapeThumbnails());

            sortSelector.addEventListener('change', (e) => {
                if(currentDirHandle) {
                    renderShortcutMode(e.target.value);
                }
                e.target.value = '';
            });
        };

    </script>
</body>
</html>
